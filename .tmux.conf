# --- 核心设置 (Core Settings) ---
# 前缀键改为 C-x (Emacs Style)
unbind C-b
set -g prefix C-x
bind C-x send-prefix

# --- Emacs 兼容模式 ---
# 连按两次 C-x 将前缀发送给内部应用 (Emacs)
# 这样:
#   C-x 2 -> Tmux 分屏
#   C-x C-x s -> Emacs 保存文件
#   C-x C-x C-f -> Emacs 打开文件
bind C-x send-prefix


# 基础索引从1开始，方便手指触摸
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on

# 鼠标支持 (调整大小时很有用)
set -g mouse on

# 减少 ESC 延迟 (对 Vim/Emacs 用户很重要)
set -sg escape-time 10

# --- 性能与体验优化 (Optimization) ---
set -s focus-events on      # 让 Neovim/Emacs 感知焦点变化 (autoread)
set -sg repeat-time 300     # 允许按键连发 (如调整大小时)
set -g detach-on-destroy off # 关闭最后一个窗口时不退出 Tmux，而是切换到其他 Session

# 增加历史记录
set -g history-limit 50000

# 256色与真彩支持
set -g default-terminal "xterm-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# --- 按键绑定 (Keybindings) ---
# 重载配置: Prefix + r
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# 分屏 (保留当前路径)
bind 2 split-window -v -c "#{pane_current_path}" # Emacs C-x 2
bind 3 split-window -h -c "#{pane_current_path}" # Emacs C-x 3
unbind '"'
unbind %

# 创建新窗口 (保留当前路径)
bind c new-window -c "#{pane_current_path}"

# 面板导航 (Emacs Style: C-n/p/f/b)
# 需要配合 Prefix 键使用，例如 C-x C-n
bind C-n select-pane -D
bind C-p select-pane -U
bind C-f select-pane -R
bind C-b select-pane -L

# 窗口切换
bind -n M-p previous-window
bind -n M-n next-window

# --- 高级功能 (Advanced) ---
# 切换多窗口同步输入 (Toggle Sync)
bind C-y set -w synchronize-panes \; display "Sync mode: #{?pane_synchronized,ON,OFF}"

# 移动当前窗口位置 (Move Window)
bind < swap-window -t -1 \; previous-window
bind > swap-window -t +1 \; next-window

# 快速调整面板大小 (Resize Panes) - Emacs Style (N/P/F/B)
bind -r B resize-pane -L 5
bind -r N resize-pane -D 5
bind -r P resize-pane -U 5
bind -r F resize-pane -R 5

# 将当前面板独立为新窗口 (Break Pane)
bind ! break-pane -d -n _hidden_pane \; swap-window -t -1 \; select-window -t +1

# --- 事件通知 (Activity Monitoring) ---
# 开启活动监控：当后台窗口有输出（如任务完成打印提示符）时高亮
setw -g monitor-activity on
set -g visual-activity on # 在状态栏显示提示信息

# 快速跳转到有活动的窗口 (Alt + a)
bind -n M-a next-window -a

# 复制模式 (Emacs Style)
setw -g mode-keys emacs
bind -T copy-mode y send-keys -X copy-pipe-and-cancel "wl-copy" # Wayland 剪贴板

# --- 插件管理 (Plugins) ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect' # 保存会话
set -g @plugin 'tmux-plugins/tmux-continuum' # 自动保存
set -g @plugin 'egel/tmux-gruvbox'          # Gruvbox 主题

# --- 插件配置 ---
# Gruvbox 主题设置
set -g @tmux-gruvbox 'dark' # or 'light'

# --- 面板边框美化 (Pane Border Styling) ---
set -g pane-border-lines heavy               # 恢复为粗线，清晰可见
set -g pane-border-status off                # 关闭顶部状态栏 (无法实现圆角，且硬直角不好看)
set -g pane-border-style "fg=#504945"        # 不活跃面板边框
set -g pane-active-border-style "fg=#fabd2f" # 活跃面板边框

# --- 弹窗功能 (Popups) ---
# 统一增加 -b rounded 参数以实现圆角边框

# 居中弹出临时终端
bind C-z display-popup -E -b rounded -w 80% -h 80%

# 弹出临时终端并打开当前目录
bind t display-popup -E -b rounded -w 80% -h 80% -d "#{pane_current_path}"

# 弹出任务管理器 (htop)
bind h display-popup -E -b rounded -w 80% -h 80% "btop"

# Git 客户端 (Lazygit)
bind g display-popup -E -b rounded -w 90% -h 90% -d "#{pane_current_path}" "lazygit"

# 文件管理器 (Ranger)
bind d display-popup -E -b rounded -w 90% -h 90% -d "#{pane_current_path}" "ranger"
unbind f

# 快速编辑器 (Neovim)
bind e display-popup -E -b rounded -w 90% -h 90% -d "#{pane_current_path}" "nvim"

# 快速编辑 Tmux 配置
bind C display-popup -E -b rounded -w 90% -h 90% "nvim ~/.tmux.conf"

# 自动恢复/保存配置
set -g @continuum-restore 'on'

# --- 快速索引导航 (Index Navigation) ---
# 禁用默认的 Prefix + 数字 切换窗口 (2和3已绑定到分屏，此处忽略)
unbind 1
unbind 4
unbind 5
unbind 6
unbind 7
unbind 8
unbind 9
unbind 0

# Alt + 1..9: 切换 Pane (直接按 Alt+数字)
bind -n M-1 select-pane -t 1
bind -n M-2 select-pane -t 2
bind -n M-3 select-pane -t 3
bind -n M-4 select-pane -t 4
bind -n M-5 select-pane -t 5
bind -n M-6 select-pane -t 6
bind -n M-7 select-pane -t 7
bind -n M-8 select-pane -t 8
bind -n M-9 select-pane -t 9

# Prefix (C-x) + Alt + 1..9: 切换 Window (先按 C-x，再按 Alt+数字)
bind M-1 select-window -t 1
bind M-2 select-window -t 2
bind M-3 select-window -t 3
bind M-4 select-window -t 4
bind M-5 select-window -t 5
bind M-6 select-window -t 6
bind M-7 select-window -t 7
bind M-8 select-window -t 8
bind M-9 select-window -t 9

# 循环切换 Pane (Alt + o)
bind -n M-o select-pane -t :.+

# 初始化 TPM (必须放在最后)
run '~/.tmux/plugins/tpm/tpm'
